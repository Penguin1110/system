<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校園清潔巡檢及故障回報系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .role-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            @apply bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .fade-in {
            display: flex;
            opacity: 1;
        }
        .slide-up {
            transform: translateY(0);
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- 全螢幕載入動畫 -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex-col items-center justify-center hidden">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
        <p id="loading-text" class="text-lg font-semibold text-gray-600">載入中...</p>
    </div>
    
    <!-- 主容器 -->
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        
        <!-- 登入頁面 -->
        <div id="login-page">
            <header class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-bold text-blue-800">校園清潔巡檢系統</h1>
                <p class="text-gray-500 mt-2">請選擇您的身份以繼續</p>
            </header>
            
            <div class="grid grid-cols-2 gap-4 md:gap-8">
                <div onclick="login('cleaner')" class="role-card bg-white p-6 rounded-2xl shadow-lg cursor-pointer text-center">
                    <i class="fas fa-broom fa-4x text-blue-500 mx-auto"></i>
                    <h2 class="text-xl font-bold mt-4">清潔人員</h2>
                </div>
                <div onclick="login('maintenance')" class="role-card bg-white p-6 rounded-2xl shadow-lg cursor-pointer text-center">
                    <i class="fas fa-tools fa-4x text-green-500 mx-auto"></i>
                    <h2 class="text-xl font-bold mt-4">維修人員</h2>
                </div>
                <div onclick="login('admin')" class="role-card bg-white p-6 rounded-2xl shadow-lg cursor-pointer text-center">
                    <i class="fas fa-chart-pie fa-4x text-purple-500 mx-auto"></i>
                    <h2 class="text-xl font-bold mt-4">管理單位</h2>
                </div>
                <div onclick="login('user')" class="role-card bg-white p-6 rounded-2xl shadow-lg cursor-pointer text-center">
                    <i class="fas fa-bullhorn fa-4x text-yellow-500 mx-auto"></i>
                    <h2 class="text-xl font-bold mt-4">一般使用者</h2>
                </div>
            </div>
        </div>

        <!-- 主操作頁面 (登入後顯示) -->
        <div id="main-page" class="hidden">
            <header class="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-md">
                <div>
                    <h1 id="page-title" class="text-2xl font-bold text-blue-800"></h1>
                    <p id="user-info" class="text-gray-500"></p>
                </div>
                <button onclick="logout()" class="text-gray-500 hover:text-red-600 transition-colors">
                    <i class="fas fa-sign-out-alt fa-lg"></i>
                    <span class="ml-2 font-semibold">登出</span>
                </button>
            </header>
            <main id="content-area"></main>
        </div>

    </div>

    <!-- 彈出式確認視窗 -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-black/50 z-40 items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-xl p-8 w-11/12 max-w-sm transform -translate-y-10">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-body" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel" class="bg-gray-200 text-gray-800 font-bold py-2 px-5 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
                <button id="modal-confirm" class="bg-red-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-600 transition-colors">確認</button>
            </div>
        </div>
    </div>


<script>
// =================================================================================
// 全域設定 (Global Configuration)
// =================================================================================
const API_BASE_URL = 'http://127.0.0.1:8000'; // 您的後端 API 網址

const USERS = {
    cleaner: { id: 1, name: '王大明', role: 'cleaner' },
    maintenance: { id: 2, name: '李師傅', role: 'maintenance' },
    admin: { id: 3, name: '陳主任', role: 'admin' },
    user: { id: 4, name: '林同學', role: 'user' },
};

let currentUser = null;
let locations = [];

// =================================================================================
// DOM 元素參考 (DOM Element References)
// =================================================================================
const loginPage = document.getElementById('login-page');
const mainPage = document.getElementById('main-page');
const contentArea = document.getElementById('content-area');
const pageTitle = document.getElementById('page-title');
const userInfo = document.getElementById('user-info');
const loadingOverlay = document.getElementById('loading-overlay');
const loadingText = document.getElementById('loading-text');

// =================================================================================
// API 請求函式 (API Fetch Functions) with Error Handling
// =================================================================================
async function apiFetch(endpoint, options = {}) {
    showLoading();
    try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: '無法解析錯誤回應' }));
            throw new Error(`伺服器錯誤: ${response.status} ${response.statusText}. ${errorData.detail || ''}`);
        }
        // 對於沒有內容的回應 (如 204 No Content)，直接返回 true
        if (response.status === 204) {
             return true;
        }
        return await response.json();
    } catch (error) {
        console.error('API 請求失敗:', error);
        // **關鍵：顯示錯誤給使用者**
        showModal('連線失敗', `無法連接至後端伺服器。<br><br><b>請確認：</b><br>1. 後端伺服器 (uvicorn) 已在終端機中成功啟動。<br>2. 沒有防火牆或防毒軟體阻擋連線。<br><br><small>詳細錯誤: ${error.message}</small>`, () => {}, { hideCancel: true, confirmText: '知道了' });
        throw error; // 重新拋出錯誤，讓呼叫者可以處理
    } finally {
        hideLoading();
    }
}


// =================================================================================
// 核心應用邏輯 (Core Application Logic)
// =================================================================================

async function login(role) {
    currentUser = USERS[role];
    if (!currentUser) {
        console.error('無效的身份:', role);
        return;
    }

    try {
        // 登入時獲取地點列表
        locations = await apiFetch('/locations');
        
        loginPage.classList.add('hidden');
        mainPage.classList.remove('hidden');
        userInfo.textContent = `你好, ${currentUser.name}`;
        
        renderPageForRole(role);
    } catch (error) {
        // 如果 API 呼叫失敗，登入過程會被中斷，錯誤訊息已由 apiFetch 顯示
        console.error("登入失敗，無法獲取初始資料。");
    }
}

function logout() {
    showModal('確認登出', '您確定要登出嗎？', () => {
        currentUser = null;
        mainPage.classList.add('hidden');
        loginPage.classList.remove('hidden');
        contentArea.innerHTML = '';
    });
}

function renderPageForRole(role) {
    contentArea.innerHTML = '';
    switch (role) {
        case 'cleaner':
            pageTitle.textContent = '清潔回報';
            renderCleanerPage();
            break;
        case 'maintenance':
            pageTitle.textContent = '維修任務';
            renderMaintenancePage();
            break;
        case 'admin':
            pageTitle.textContent = '管理儀表板';
            renderAdminPage();
            break;
        case 'user':
            pageTitle.textContent = '問題回報';
            renderUserPage();
            break;
    }
}

// =================================================================================
// 各角色頁面渲染 (Page Rendering for Roles)
// =================================================================================

// 清潔人員頁面
function renderCleanerPage() {
    const locationOptions = locations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('');
    contentArea.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-bold mb-4">回報清潔區域</h2>
            <form id="clean-form">
                <div class="mb-4">
                    <label for="location" class="block text-gray-700 font-semibold mb-2">選擇地點</label>
                    <select id="location" name="location" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        ${locationOptions}
                    </select>
                </div>
                <button type="submit" class="btn-primary w-full">
                    <i class="fas fa-check mr-2"></i>確認清潔完成
                </button>
            </form>
        </div>
    `;
    document.getElementById('clean-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const locationId = e.target.location.value;
        const locationName = locations.find(l => l.id == locationId).name;

        showModal('確認回報', `您確定要回報「${locationName}」已清潔完成嗎？`, async () => {
            try {
                await apiFetch('/cleaning-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location_id: parseInt(locationId), user_id: currentUser.id })
                });
                showModal('回報成功', `「${locationName}」的清潔紀錄已成功送出。`, () => {}, { hideCancel: true, confirmText: '完成' });
            } catch (error) {
                // 錯誤已由 apiFetch 處理
            }
        });
    });
}

// 維修人員頁面
async function renderMaintenancePage() {
    try {
        const reports = await apiFetch('/repair-reports');
        let reportsHtml = reports.map(report => `
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 ${getStatusColor(report.status)}">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg">${report.location.name}</p>
                        <p class="text-gray-600">${report.description}</p>
                        <p class="text-sm text-gray-400 mt-2">回報人: ${report.reporter.name} | 回報時間: ${new Date(report.created_at).toLocaleString()}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-semibold px-3 py-1 rounded-full ${getStatusBgColor(report.status)}">
                            ${getStatusText(report.status)}
                        </span>
                    </div>
                </div>
                ${report.image_url ? `<a href="${API_BASE_URL}/${report.image_url}" target="_blank"><img src="${API_BASE_URL}/${report.image_url}" class="mt-4 rounded-lg max-h-48 cursor-pointer"/></a>` : ''}
                <div class="mt-4 flex gap-2">
                    ${report.status !== 'pending' ? `<button onclick="updateStatus(${report.id}, 'pending')" class="bg-gray-500 text-white text-sm py-1 px-3 rounded-md hover:bg-gray-600">設為待處理</button>` : ''}
                    ${report.status !== 'in_progress' ? `<button onclick="updateStatus(${report.id}, 'in_progress')" class="bg-yellow-500 text-white text-sm py-1 px-3 rounded-md hover:bg-yellow-600">設為維修中</button>` : ''}
                    ${report.status !== 'completed' ? `<button onclick="updateStatus(${report.id}, 'completed')" class="bg-green-500 text-white text-sm py-1 px-3 rounded-md hover:bg-green-600">設為已完成</button>` : ''}
                </div>
            </div>
        `).join('');

        if (reports.length === 0) {
            reportsHtml = `<div class="text-center py-10 bg-white rounded-lg shadow-md"><i class="fas fa-check-circle text-green-500 fa-3x mb-4"></i><p class="text-gray-500">太棒了！目前沒有待處理的維修任務。</p></div>`;
        }

        contentArea.innerHTML = `<div class="space-y-4">${reportsHtml}</div>`;
    } catch (error) {
        contentArea.innerHTML = `<div class="text-center py-10 bg-red-50 text-red-700 rounded-lg shadow-md"><p>無法載入維修列表。</p></div>`;
    }
}

// 管理單位頁面
async function renderAdminPage() {
    try {
        const [stats, cleaning, repairs] = await Promise.all([
            apiFetch('/admin/stats'),
            apiFetch('/cleaning-records'),
            apiFetch('/repair-reports')
        ]);
        
        const repairDist = stats.repair_status_distribution;
        const totalRepairs = repairDist.pending + repairDist.in_progress + repairDist.completed;

        contentArea.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-md text-center">
                    <p class="text-gray-500">待處理維修</p>
                    <p class="text-4xl font-bold text-red-500">${repairDist.pending}</p>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md text-center">
                    <p class="text-gray-500">維修中</p>
                    <p class="text-4xl font-bold text-yellow-500">${repairDist.in_progress}</p>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md text-center">
                    <p class="text-gray-500">今日清潔次數</p>
                    <p class="text-4xl font-bold text-blue-500">${stats.weekly_cleaning.find(d => d.day === new Date().toString().slice(0,3))?.count || 0}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4">最近清潔紀錄</h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${cleaning.length > 0 ? cleaning.map(r => `
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="font-semibold">${r.location.name}</p>
                                <p class="text-sm text-gray-500">清潔人員: ${r.user.name} | ${new Date(r.timestamp).toLocaleString()}</p>
                            </div>
                        `).join('') : '<p class="text-gray-500">暫無紀錄</p>'}
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4">最近故障回報</h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${repairs.length > 0 ? repairs.map(r => `
                             <div class="p-3 rounded-lg border-l-4 ${getStatusColor(r.status)}">
                                <p class="font-semibold">${r.location.name} <span class="text-sm font-semibold px-2 py-0.5 rounded-full ${getStatusBgColor(r.status)}">${getStatusText(r.status)}</span></p>
                                <p class="text-sm text-gray-600">${r.description}</p>
                                <p class="text-xs text-gray-400">回報人: ${r.reporter.name} | ${new Date(r.created_at).toLocaleString()}</p>
                            </div>
                        `).join('') : '<p class="text-gray-500">暫無紀錄</p>'}
                    </div>
                </div>
            </div>
        `;
    } catch(error) {
         contentArea.innerHTML = `<div class="text-center py-10 bg-red-50 text-red-700 rounded-lg shadow-md"><p>無法載入管理數據。</p></div>`;
    }
}

// 一般使用者頁面
function renderUserPage() {
    const locationOptions = locations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('');
    contentArea.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-bold mb-4">回報環境或設備問題</h2>
            <form id="report-form">
                <div class="mb-4">
                    <label for="report-location" class="block text-gray-700 font-semibold mb-2">地點</label>
                    <select id="report-location" name="location" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        ${locationOptions}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-gray-700 font-semibold mb-2">問題描述</label>
                    <textarea id="description" name="description" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="例如：水龍頭漏水、廁所很髒亂..." required></textarea>
                </div>
                 <div class="mb-6">
                    <label for="image" class="block text-gray-700 font-semibold mb-2">上傳照片 (可選)</label>
                    <input type="file" id="image" name="image" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <button type="submit" class="btn-primary w-full">
                    <i class="fas fa-paper-plane mr-2"></i>確認送出
                </button>
            </form>
        </div>
    `;
    document.getElementById('report-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        formData.append('reported_by_user_id', currentUser.id);

        try {
            showLoading('傳送中...');
            await apiFetch('/repair-reports', {
                method: 'POST',
                body: formData,
            });
            e.target.reset();
            showModal('回報成功', '感謝您的回報，我們將盡快處理！', () => {}, { hideCancel: true, confirmText: '完成' });
        } catch (error) {
            // 錯誤已由 apiFetch 處理
        } finally {
            hideLoading();
        }
    });
}

async function updateStatus(reportId, status) {
    const statusText = getStatusText(status);
    showModal('更新狀態', `確定要將此案件狀態更新為「${statusText}」嗎？`, async () => {
        try {
            await apiFetch(`/repair-reports/${reportId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            renderMaintenancePage(); // 重新整理列表
        } catch (error) {
            // 錯誤已由 apiFetch 處理
        }
    });
}


// =================================================================================
// 輔助函式 (Utility Functions)
// =================================================================================
function showLoading(text = '載入中...') {
    loadingText.textContent = text;
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
}

function hideLoading() {
    loadingOverlay.classList.add('hidden');
    loadingOverlay.classList.remove('flex');
}

function showModal(title, body, onConfirm, options = {}) {
    const { hideCancel = false, confirmText = '確認', cancelText = '取消' } = options;
    document.getElementById('modal-title').innerHTML = title;
    document.getElementById('modal-body').innerHTML = body;
    const confirmBtn = document.getElementById('modal-confirm');
    const cancelBtn = document.getElementById('modal-cancel');
    
    confirmBtn.textContent = confirmText;
    cancelBtn.textContent = cancelText;

    if (hideCancel) {
        cancelBtn.classList.add('hidden');
    } else {
        cancelBtn.classList.remove('hidden');
    }

    const modal = document.getElementById('confirm-modal');
    modal.classList.add('fade-in');
    setTimeout(() => modal.querySelector('.modal-content').classList.add('slide-up'), 10);

    const closeModal = () => {
        modal.classList.remove('fade-in');
        modal.querySelector('.modal-content').classList.remove('slide-up');
        confirmBtn.onclick = null;
        cancelBtn.onclick = null;
    };

    confirmBtn.onclick = () => {
        onConfirm();
        closeModal();
    };
    cancelBtn.onclick = closeModal;
}

function getStatusColor(status) {
    switch (status) {
        case 'pending': return 'border-red-500';
        case 'in_progress': return 'border-yellow-500';
        case 'completed': return 'border-green-500';
        default: return 'border-gray-400';
    }
}
function getStatusBgColor(status) {
    switch (status) {
        case 'pending': return 'bg-red-100 text-red-800';
        case 'in_progress': return 'bg-yellow-100 text-yellow-800';
        case 'completed': return 'bg-green-100 text-green-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}
function getStatusText(status) {
    switch (status) {
        case 'pending': return '待處理';
        case 'in_progress': return '維修中';
        case 'completed': return '已完成';
        default: return '未知';
    }
}

</script>
</body>
</html>

